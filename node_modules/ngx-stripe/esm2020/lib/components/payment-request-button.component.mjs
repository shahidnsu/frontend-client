import { CommonModule } from '@angular/common';
import { Component, Input, ViewChild, EventEmitter, Output, Optional } from '@angular/core';
import { from, lastValueFrom } from 'rxjs';
import * as i0 from "@angular/core";
import * as i1 from "../services/stripe-elements.service";
import * as i2 from "../directives/elements.directive";
export class StripePaymentRequestButtonComponent {
    constructor(stripeElementsService, elementsProvider) {
        this.stripeElementsService = stripeElementsService;
        this.elementsProvider = elementsProvider;
        this.load = new EventEmitter();
        this.change = new EventEmitter();
        this.blur = new EventEmitter();
        this.focus = new EventEmitter();
        this.ready = new EventEmitter();
        this.token = new EventEmitter();
        this.paymentMethod = new EventEmitter();
        this.source = new EventEmitter();
        this.cancel = new EventEmitter();
        this.shippingaddresschange = new EventEmitter();
        this.shippingoptionchange = new EventEmitter();
        this.notavailable = new EventEmitter();
        this.state = 'notready';
    }
    async ngOnChanges(changes) {
        let updateElements = false;
        if (!this.elementsProvider && (changes.elementsOptions || changes.stripe || !this.elements)) {
            const elements = await lastValueFrom(this.stripeElementsService.elements(this.stripe, this.elementsOptions));
            this.elements = elements;
            updateElements = true;
        }
        if (changes.paymentOptions && this.paymentRequest) {
            this.updateRequest(this.paymentOptions);
        }
        const options = this.stripeElementsService.mergeOptions(this.options, this.containerClass);
        if (changes.options || changes.containerClass || !this.element || updateElements) {
            if (this.element && !updateElements) {
                this.update(options);
            }
            else if (this.elements && updateElements) {
                this.createElement(options);
            }
        }
    }
    async ngOnInit() {
        const options = this.stripeElementsService.mergeOptions(this.options, this.containerClass);
        if (this.elementsProvider) {
            this.elementsSubscription = this.elementsProvider.elements.subscribe((elements) => {
                this.elements = elements;
                this.createElement(options);
                this.state = 'ready';
            });
        }
        else if (this.state === 'notready') {
            this.state = 'starting';
            this.elements = await lastValueFrom(this.stripeElementsService.elements(this.stripe));
            this.createElement(options);
            this.state = 'ready';
        }
    }
    ngOnDestroy() {
        if (this.element) {
            this.element.destroy();
        }
        if (this.elementsSubscription) {
            this.elementsSubscription.unsubscribe();
        }
    }
    canMakePayment() {
        return from(this.paymentRequest.canMakePayment());
    }
    update(options) {
        this.element.update(options);
    }
    updateRequest(options) {
        const { currency, total, displayItems, shippingOptions } = options;
        this.paymentRequest.update({
            currency,
            total,
            displayItems,
            shippingOptions
        });
    }
    show() {
        this.paymentRequest.show();
    }
    abort() {
        this.paymentRequest.abort();
    }
    isShowing() {
        return this.paymentRequest.isShowing();
    }
    /**
     * @deprecated
     */
    getButton() {
        return this.element;
    }
    async createElement(options = {}) {
        this.paymentRequest = this.stripeElementsService.paymentRequest(this.stripe, this.paymentOptions);
        this.paymentRequest.on('token', (ev) => this.token.emit(ev));
        if (this.paymentMethod.observed)
            this.paymentRequest.on('paymentmethod', (ev) => this.paymentMethod.emit(ev));
        if (this.source.observed && !this.paymentMethod.observed)
            this.paymentRequest.on('source', (ev) => this.source.emit(ev));
        this.paymentRequest.on('cancel', () => this.cancel.emit());
        this.paymentRequest.on('shippingaddresschange', (ev) => this.shippingaddresschange.emit(ev));
        this.paymentRequest.on('shippingoptionchange', (ev) => this.shippingoptionchange.emit(ev));
        if (this.element) {
            this.element.unmount();
        }
        this.element = this.elements.create('paymentRequestButton', {
            paymentRequest: this.paymentRequest,
            ...options
        });
        const result = await this.paymentRequest.canMakePayment();
        if (result) {
            this.element.on('click', (ev) => this.change.emit(ev));
            this.element.on('blur', () => this.blur.emit());
            this.element.on('focus', () => this.focus.emit());
            this.element.on('ready', () => this.ready.emit());
            this.element.mount(this.stripeElementRef.nativeElement);
            this.load.emit({
                paymentRequestButton: this.element,
                paymentRequest: this.paymentRequest
            });
        }
        else {
            this.notavailable.emit();
        }
    }
}
StripePaymentRequestButtonComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.1.0", ngImport: i0, type: StripePaymentRequestButtonComponent, deps: [{ token: i1.StripeElementsService }, { token: i2.StripeElementsDirective, optional: true }], target: i0.ɵɵFactoryTarget.Component });
StripePaymentRequestButtonComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "15.1.0", type: StripePaymentRequestButtonComponent, isStandalone: true, selector: "ngx-stripe-payment-request-button", inputs: { containerClass: "containerClass", paymentOptions: "paymentOptions", options: "options", elementsOptions: "elementsOptions", stripe: "stripe" }, outputs: { load: "load", change: "change", blur: "blur", focus: "focus", ready: "ready", token: "token", paymentMethod: "paymentMethod", source: "source", cancel: "cancel", shippingaddresschange: "shippingaddresschange", shippingoptionchange: "shippingoptionchange", notavailable: "notavailable" }, viewQueries: [{ propertyName: "stripeElementRef", first: true, predicate: ["stripeElementRef"], descendants: true }], usesOnChanges: true, ngImport: i0, template: `<div class="field" #stripeElementRef></div>`, isInline: true, dependencies: [{ kind: "ngmodule", type: CommonModule }] });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.1.0", ngImport: i0, type: StripePaymentRequestButtonComponent, decorators: [{
            type: Component,
            args: [{
                    selector: 'ngx-stripe-payment-request-button',
                    standalone: true,
                    template: `<div class="field" #stripeElementRef></div>`,
                    imports: [CommonModule]
                }]
        }], ctorParameters: function () { return [{ type: i1.StripeElementsService }, { type: i2.StripeElementsDirective, decorators: [{
                    type: Optional
                }] }]; }, propDecorators: { stripeElementRef: [{
                type: ViewChild,
                args: ['stripeElementRef']
            }], containerClass: [{
                type: Input
            }], paymentOptions: [{
                type: Input
            }], options: [{
                type: Input
            }], elementsOptions: [{
                type: Input
            }], stripe: [{
                type: Input
            }], load: [{
                type: Output
            }], change: [{
                type: Output
            }], blur: [{
                type: Output
            }], focus: [{
                type: Output
            }], ready: [{
                type: Output
            }], token: [{
                type: Output
            }], paymentMethod: [{
                type: Output
            }], source: [{
                type: Output
            }], cancel: [{
                type: Output
            }], shippingaddresschange: [{
                type: Output
            }], shippingoptionchange: [{
                type: Output
            }], notavailable: [{
                type: Output
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGF5bWVudC1yZXF1ZXN0LWJ1dHRvbi5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9uZ3gtc3RyaXBlL3NyYy9saWIvY29tcG9uZW50cy9wYXltZW50LXJlcXVlc3QtYnV0dG9uLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDL0MsT0FBTyxFQUNMLFNBQVMsRUFDVCxLQUFLLEVBQ0wsU0FBUyxFQUVULFlBQVksRUFDWixNQUFNLEVBR04sUUFBUSxFQUdULE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBYyxJQUFJLEVBQWdCLGFBQWEsRUFBRSxNQUFNLE1BQU0sQ0FBQzs7OztBQStCckUsTUFBTSxPQUFPLG1DQUFtQztJQWlDOUMsWUFDUyxxQkFBNEMsRUFDL0IsZ0JBQXlDO1FBRHRELDBCQUFxQixHQUFyQixxQkFBcUIsQ0FBdUI7UUFDL0IscUJBQWdCLEdBQWhCLGdCQUFnQixDQUF5QjtRQXhCckQsU0FBSSxHQUFHLElBQUksWUFBWSxFQUc3QixDQUFDO1FBRUssV0FBTSxHQUFHLElBQUksWUFBWSxFQUErQyxDQUFDO1FBQ3pFLFNBQUksR0FBRyxJQUFJLFlBQVksRUFBUSxDQUFDO1FBQ2hDLFVBQUssR0FBRyxJQUFJLFlBQVksRUFBUSxDQUFDO1FBQ2pDLFVBQUssR0FBRyxJQUFJLFlBQVksRUFBUSxDQUFDO1FBRWpDLFVBQUssR0FBRyxJQUFJLFlBQVksRUFBNEIsQ0FBQztRQUNyRCxrQkFBYSxHQUFHLElBQUksWUFBWSxFQUFvQyxDQUFDO1FBQ3JFLFdBQU0sR0FBRyxJQUFJLFlBQVksRUFBNkIsQ0FBQztRQUN2RCxXQUFNLEdBQUcsSUFBSSxZQUFZLEVBQVEsQ0FBQztRQUNsQywwQkFBcUIsR0FBRyxJQUFJLFlBQVksRUFBc0MsQ0FBQztRQUMvRSx5QkFBb0IsR0FBRyxJQUFJ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eEI7OzBCQW9DSSxRQUFROzRDQWxDMkIsZ0JBQWdCO3NCQUFyRCxTQUFTO3VCQUFDLGtCQUFrQjtnQkFJcEIsY0FBYztzQkFBdEIsS0FBSztnQkFDRyxjQUFjO3NCQUF0QixLQUFLO2dCQUNHLE9BQU87c0JBQWYsS0FBSztnQkFDRyxlQUFlO3NCQUF2QixLQUFLO2dCQUNHLE1BQU07c0JBQWQsS0FBSztnQkFFSSxJQUFJO3NCQUFiLE1BQU07Z0JBS0csTUFBTTtzQkFBZixNQUFNO2dCQUNHLElBQUk7c0JBQWIsTUFBTTtnQkFDRyxLQUFLO3NCQUFkLE1BQU07Z0JBQ0csS0FBSztzQkFBZCxNQUFNO2dCQUVHLEtBQUs7c0JBQWQsTUFBTTtnQkFDRyxhQUFhO3NCQUF0QixNQUFNO2dCQUNHLE1BQU07c0JBQWYsTUFBTTtnQkFDRyxNQUFNO3NCQUFmLE1BQU07Z0JBQ0cscUJBQXFCO3NCQUE5QixNQUFNO2dCQUNHLG9CQUFvQjtzQkFBN0IsTUFBTTtnQkFDRyxZQUFZO3NCQUFyQixNQUFNIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tbW9uTW9kdWxlIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcbmltcG9ydCB7XG4gIENvbXBvbmVudCxcbiAgSW5wdXQsXG4gIFZpZXdDaGlsZCxcbiAgRWxlbWVudFJlZixcbiAgRXZlbnRFbWl0dGVyLFxuICBPdXRwdXQsXG4gIE9uQ2hhbmdlcyxcbiAgU2ltcGxlQ2hhbmdlcyxcbiAgT3B0aW9uYWwsXG4gIE9uSW5pdCxcbiAgT25EZXN0cm95XG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgZnJvbSwgU3Vic2NyaXB0aW9uLCBsYXN0VmFsdWVGcm9tIH0gZnJvbSAncnhqcyc7XG5cbmltcG9ydCB7XG4gIFN0cmlwZUVsZW1lbnRzT3B0aW9ucyxcbiAgU3RyaXBlRWxlbWVudHMsXG4gIFBheW1lbnRSZXF1ZXN0T3B0aW9ucyxcbiAgUGF5bWVudFJlcXVlc3QsXG4gIENhbk1ha2VQYXltZW50UmVzdWx0LFxuICBQYXltZW50UmVxdWVzdFVwZGF0ZU9wdGlvbnMsXG4gIFN0cmlwZVBheW1lbnRSZXF1ZXN0QnV0dG9uRWxlbWVudCxcbiAgU3RyaXBlUGF5bWVudFJlcXVlc3RCdXR0b25FbGVtZW50T3B0aW9ucyxcbiAgU3RyaXBlUGF5bWVudFJlcXVlc3RCdXR0b25FbGVtZW50Q2xpY2tFdmVudCxcbiAgUGF5bWVudFJlcXVlc3RUb2tlbkV2ZW50LFxuICBQYXltZW50UmVxdWVzdFBheW1lbnRNZXRob2RFdmVudCxcbiAgUGF5bWVudFJlcXVlc3RTb3VyY2VFdmVudCxcbiAgUGF5bWVudFJlcXVlc3RTaGlwcGluZ0FkZHJlc3NFdmVudCxcbiAgUGF5bWVudFJlcXVlc3RTaGlwcGluZ09wdGlvbkV2ZW50XG59IGZyb20gJ0BzdHJpcGUvc3RyaXBlLWpzJztcblxuaW1wb3J0IHsgU3RyaXBlRWxlbWVudHNEaXJlY3RpdmUgfSBmcm9tICcuLi9kaXJlY3RpdmVzL2VsZW1lbnRzLmRpcmVjdGl2ZSc7XG5cbmltcG9ydCB7IFN0cmlwZVNlcnZpY2VJbnRlcmZhY2UgfSBmcm9tICcuLi9pbnRlcmZhY2VzL3N0cmlwZS1pbnN0YW5jZS5pbnRlcmZhY2UnO1xuXG5pbXBvcnQgeyBTdHJpcGVFbGVtZW50c1NlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy9zdHJpcGUtZWxlbWVudHMuc2VydmljZSc7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ25neC1zdHJpcGUtcGF5bWVudC1yZXF1ZXN0LWJ1dHRvbicsXG4gIHN0YW5kYWxvbmU6IHRydWUsXG4gIHRlbXBsYXRlOiBgPGRpdiBjbGFzcz1cImZpZWxkXCIgI3N0cmlwZUVsZW1lbnRSZWY+PC9kaXY+YCxcbiAgaW1wb3J0czogW0NvbW1vbk1vZHVsZV1cbn0pXG5leHBvcnQgY2xhc3MgU3RyaXBlUGF5bWVudFJlcXVlc3RCdXR0b25Db21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQsIE9uQ2hhbmdlcywgT25EZXN0cm95IHtcbiAgQFZpZXdDaGlsZCgnc3RyaXBlRWxlbWVudFJlZicpIHB1YmxpYyBzdHJpcGVFbGVtZW50UmVmITogRWxlbWVudFJlZjtcbiAgZWxlbWVudCE6IFN0cmlwZVBheW1lbnRSZXF1ZXN0QnV0dG9uRWxlbWVudDtcbiAgcGF5bWVudFJlcXVlc3QhOiBQYXltZW50UmVxdWVzdDtcblxuICBASW5wdXQoKSBjb250YWluZXJDbGFzczogc3RyaW5nO1xuICBASW5wdXQoKSBwYXltZW50T3B0aW9uczogUGF5bWVudFJlcXVlc3RPcHRpb25zO1xuICBASW5wdXQoKSBvcHRpb25zOiBTdHJpcGVQYXltZW50UmVxdWVzdEJ1dHRvbkVsZW1lbnRPcHRpb25zO1xuICBASW5wdXQoKSBlbGVtZW50c09wdGlvbnM6IFBhcnRpYWw8U3RyaXBlRWxlbWVudHNPcHRpb25zPjtcbiAgQElucHV0KCkgc3RyaXBlOiBTdHJpcGVTZXJ2aWNlSW50ZXJmYWNlO1xuXG4gIEBPdXRwdXQoKSBsb2FkID0gbmV3IEV2ZW50RW1pdHRlcjx7XG4gICAgcGF5bWVudFJlcXVlc3RCdXR0b246IFN0cmlwZVBheW1lbnRSZXF1ZXN0QnV0dG9uRWxlbWVudDtcbiAgICBwYXltZW50UmVxdWVzdDogUGF5bWVudFJlcXVlc3Q7XG4gIH0+KCk7XG5cbiAgQE91dHB1dCgpIGNoYW5nZSA9IG5ldyBFdmVudEVtaXR0ZXI8U3RyaXBlUGF5bWVudFJlcXVlc3RCdXR0b25FbGVtZW50Q2xpY2tFdmVudD4oKTtcbiAgQE91dHB1dCgpIGJsdXIgPSBuZXcgRXZlbnRFbWl0dGVyPHZvaWQ+KCk7XG4gIEBPdXRwdXQoKSBmb2N1cyA9IG5ldyBFdmVudEVtaXR0ZXI8dm9pZD4oKTtcbiAgQE91dHB1dCgpIHJlYWR5ID0gbmV3IEV2ZW50RW1pdHRlcjx2b2lkPigpO1xuXG4gIEBPdXRwdXQoKSB0b2tlbiA9IG5ldyBFdmVudEVtaXR0ZXI8UGF5bWVudFJlcXVlc3RUb2tlbkV2ZW50PigpO1xuICBAT3V0cHV0KCkgcGF5bWVudE1ldGhvZCA9IG5ldyBFdmVudEVtaXR0ZXI8UGF5bWVudFJlcXVlc3RQYXltZW50TWV0aG9kRXZlbnQ+KCk7XG4gIEBPdXRwdXQoKSBzb3VyY2UgPSBuZXcgRXZlbnRFbWl0dGVyPFBheW1lbnRSZXF1ZXN0U291cmNlRXZlbnQ+KCk7XG4gIEBPdXRwdXQoKSBjYW5jZWwgPSBuZXcgRXZlbnRFbWl0dGVyPHZvaWQ+KCk7XG4gIEBPdXRwdXQoKSBzaGlwcGluZ2FkZHJlc3NjaGFuZ2UgPSBuZXcgRXZlbnRFbWl0dGVyPFBheW1lbnRSZXF1ZXN0U2hpcHBpbmdBZGRyZXNzRXZlbnQ+KCk7XG4gIEBPdXRwdXQoKSBzaGlwcGluZ29wdGlvbmNoYW5nZSA9IG5ldyBFdmVudEVtaXR0ZXI8UGF5bWVudFJlcXVlc3RTaGlwcGluZ09wdGlvbkV2ZW50PigpO1xuICBAT3V0cHV0KCkgbm90YXZhaWxhYmxlID0gbmV3IEV2ZW50RW1pdHRlcjx2b2lkPigpO1xuXG4gIGVsZW1lbnRzOiBTdHJpcGVFbGVtZW50cztcbiAgcHJpdmF0ZSBzdGF0ZTogJ25vdHJlYWR5JyB8ICdzdGFydGluZycgfCAncmVhZHknID0gJ25vdHJlYWR5JztcbiAgcHJpdmF0ZSBlbGVtZW50c1N1YnNjcmlwdGlvbjogU3Vic2NyaXB0aW9uO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHB1YmxpYyBzdHJpcGVFbGVtZW50c1NlcnZpY2U6IFN0cmlwZUVsZW1lbnRzU2VydmljZSxcbiAgICBAT3B0aW9uYWwoKSBwcml2YXRlIGVsZW1lbnRzUHJvdmlkZXI6IFN0cmlwZUVsZW1lbnRzRGlyZWN0aXZlXG4gICkge31cblxuICBhc3luYyBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKSB7XG4gICAgbGV0IHVwZGF0ZUVsZW1lbnRzID0gZmFsc2U7XG5cbiAgICBpZiAoIXRoaXMuZWxlbWVudHNQcm92aWRlciAmJiAoY2hhbmdlcy5lbGVtZW50c09wdGlvbnMgfHwgY2hhbmdlcy5zdHJpcGUgfHwgIXRoaXMuZWxlbWVudHMpKSB7XG4gICAgICBjb25zdCBlbGVtZW50cyA9IGF3YWl0IGxhc3RWYWx1ZUZyb20odGhpcy5zdHJpcGVFbGVtZW50c1NlcnZpY2UuZWxlbWVudHModGhpcy5zdHJpcGUsIHRoaXMuZWxlbWVudHNPcHRpb25zKSk7XG4gICAgICB0aGlzLmVsZW1lbnRzID0gZWxlbWVudHM7XG4gICAgICB1cGRhdGVFbGVtZW50cyA9IHRydWU7XG4gICAgfVxuXG4gICAgaWYgKGNoYW5nZXMucGF5bWVudE9wdGlvbnMgJiYgdGhpcy5wYXltZW50UmVxdWVzdCkge1xuICAgICAgdGhpcy51cGRhdGVSZXF1ZXN0KHRoaXMucGF5bWVudE9wdGlvbnMpO1xuICAgIH1cblxuICAgIGNvbnN0IG9wdGlvbnMgPSB0aGlzLnN0cmlwZUVsZW1lbnRzU2VydmljZS5tZXJnZU9wdGlvbnModGhpcy5vcHRpb25zLCB0aGlzLmNvbnRhaW5lckNsYXNzKTtcbiAgICBpZiAoY2hhbmdlcy5vcHRpb25zIHx8IGNoYW5nZXMuY29udGFpbmVyQ2xhc3MgfHwgIXRoaXMuZWxlbWVudCB8fCB1cGRhdGVFbGVtZW50cykge1xuICAgICAgaWYgKHRoaXMuZWxlbWVudCAmJiAhdXBkYXRlRWxlbWVudHMpIHtcbiAgICAgICAgdGhpcy51cGRhdGUob3B0aW9ucyk7XG4gICAgICB9IGVsc2UgaWYgKHRoaXMuZWxlbWVudHMgJiYgdXBkYXRlRWxlbWVudHMpIHtcbiAgICAgICAgdGhpcy5jcmVhdGVFbGVtZW50KG9wdGlvbnMpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGFzeW5jIG5nT25Jbml0KCkge1xuICAgIGNvbnN0IG9wdGlvbnMgPSB0aGlzLnN0cmlwZUVsZW1lbnRzU2VydmljZS5tZXJnZU9wdGlvbnModGhpcy5vcHRpb25zLCB0aGlzLmNvbnRhaW5lckNsYXNzKTtcblxuICAgIGlmICh0aGlzLmVsZW1lbnRzUHJvdmlkZXIpIHtcbiAgICAgIHRoaXMuZWxlbWVudHNTdWJzY3JpcHRpb24gPSB0aGlzLmVsZW1lbnRzUHJvdmlkZXIuZWxlbWVudHMuc3Vic2NyaWJlKChlbGVtZW50cykgPT4ge1xuICAgICAgICB0aGlzLmVsZW1lbnRzID0gZWxlbWVudHM7XG4gICAgICAgIHRoaXMuY3JlYXRlRWxlbWVudChvcHRpb25zKTtcbiAgICAgICAgdGhpcy5zdGF0ZSA9ICdyZWFkeSc7XG4gICAgICB9KTtcbiAgICB9IGVsc2UgaWYgKHRoaXMuc3RhdGUgPT09ICdub3RyZWFkeScpIHtcbiAgICAgIHRoaXMuc3RhdGUgPSAnc3RhcnRpbmcnO1xuXG4gICAgICB0aGlzLmVsZW1lbnRzID0gYXdhaXQgbGFzdFZhbHVlRnJvbSh0aGlzLnN0cmlwZUVsZW1lbnRzU2VydmljZS5lbGVtZW50cyh0aGlzLnN0cmlwZSkpO1xuICAgICAgdGhpcy5jcmVhdGVFbGVtZW50KG9wdGlvbnMpO1xuXG4gICAgICB0aGlzLnN0YXRlID0gJ3JlYWR5JztcbiAgICB9XG4gIH1cblxuICBuZ09uRGVzdHJveSgpIHtcbiAgICBpZiAodGhpcy5lbGVtZW50KSB7XG4gICAgICB0aGlzLmVsZW1lbnQuZGVzdHJveSgpO1xuICAgIH1cbiAgICBpZiAodGhpcy5lbGVtZW50c1N1YnNjcmlwdGlvbikge1xuICAgICAgdGhpcy5lbGVtZW50c1N1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgIH1cbiAgfVxuXG4gIGNhbk1ha2VQYXltZW50KCk6IE9ic2VydmFibGU8Q2FuTWFrZVBheW1lbnRSZXN1bHQgfCBudWxsPiB7XG4gICAgcmV0dXJuIGZyb20odGhpcy5wYXltZW50UmVxdWVzdC5jYW5NYWtlUGF5bWVudCgpKTtcbiAgfVxuXG4gIHVwZGF0ZShvcHRpb25zOiBQYXJ0aWFsPFN0cmlwZVBheW1lbnRSZXF1ZXN0QnV0dG9uRWxlbWVudE9wdGlvbnM+KSB7XG4gICAgdGhpcy5lbGVtZW50LnVwZGF0ZShvcHRpb25zKTtcbiAgfVxuXG4gIHVwZGF0ZVJlcXVlc3Qob3B0aW9uczogUGF5bWVudFJlcXVlc3RVcGRhdGVPcHRpb25zKSB7XG4gICAgY29uc3QgeyBjdXJyZW5jeSwgdG90YWwsIGRpc3BsYXlJdGVtcywgc2hpcHBpbmdPcHRpb25zIH0gPSBvcHRpb25zO1xuXG4gICAgdGhpcy5wYXltZW50UmVxdWVzdC51cGRhdGUoe1xuICAgICAgY3VycmVuY3ksXG4gICAgICB0b3RhbCxcbiAgICAgIGRpc3BsYXlJdGVtcyxcbiAgICAgIHNoaXBwaW5nT3B0aW9uc1xuICAgIH0pO1xuICB9XG5cbiAgc2hvdygpOiB2b2lkIHtcbiAgICB0aGlzLnBheW1lbnRSZXF1ZXN0LnNob3coKTtcbiAgfVxuXG4gIGFib3J0KCk6IHZvaWQge1xuICAgIHRoaXMucGF5bWVudFJlcXVlc3QuYWJvcnQoKTtcbiAgfVxuXG4gIGlzU2hvd2luZygpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5wYXltZW50UmVxdWVzdC5pc1Nob3dpbmcoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAZGVwcmVjYXRlZFxuICAgKi9cbiAgZ2V0QnV0dG9uKCkge1xuICAgIHJldHVybiB0aGlzLmVsZW1lbnQ7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGNyZWF0ZUVsZW1lbnQob3B0aW9uczogUGFydGlhbDxTdHJpcGVQYXltZW50UmVxdWVzdEJ1dHRvbkVsZW1lbnRPcHRpb25zPiA9IHt9KSB7XG4gICAgdGhpcy5wYXltZW50UmVxdWVzdCA9IHRoaXMuc3RyaXBlRWxlbWVudHNTZXJ2aWNlLnBheW1lbnRSZXF1ZXN0KHRoaXMuc3RyaXBlLCB0aGlzLnBheW1lbnRPcHRpb25zKTtcbiAgICB0aGlzLnBheW1lbnRSZXF1ZXN0Lm9uKCd0b2tlbicsIChldikgPT4gdGhpcy50b2tlbi5lbWl0KGV2KSk7XG4gICAgaWYgKHRoaXMucGF5bWVudE1ldGhvZC5vYnNlcnZlZCkgdGhpcy5wYXltZW50UmVxdWVzdC5vbigncGF5bWVudG1ldGhvZCcsIChldikgPT4gdGhpcy5wYXltZW50TWV0aG9kLmVtaXQoZXYpKTtcbiAgICBpZiAodGhpcy5zb3VyY2Uub2JzZXJ2ZWQgJiYgIXRoaXMucGF5bWVudE1ldGhvZC5vYnNlcnZlZClcbiAgICAgIHRoaXMucGF5bWVudFJlcXVlc3Qub24oJ3NvdXJjZScsIChldikgPT4gdGhpcy5zb3VyY2UuZW1pdChldikpO1xuICAgIHRoaXMucGF5bWVudFJlcXVlc3Qub24oJ2NhbmNlbCcsICgpID0+IHRoaXMuY2FuY2VsLmVtaXQoKSk7XG4gICAgdGhpcy5wYXltZW50UmVxdWVzdC5vbignc2hpcHBpbmdhZGRyZXNzY2hhbmdlJywgKGV2KSA9PiB0aGlzLnNoaXBwaW5nYWRkcmVzc2NoYW5nZS5lbWl0KGV2KSk7XG4gICAgdGhpcy5wYXltZW50UmVxdWVzdC5vbignc2hpcHBpbmdvcHRpb25jaGFuZ2UnLCAoZXYpID0+IHRoaXMuc2hpcHBpbmdvcHRpb25jaGFuZ2UuZW1pdChldikpO1xuXG4gICAgaWYgKHRoaXMuZWxlbWVudCkge1xuICAgICAgdGhpcy5lbGVtZW50LnVubW91bnQoKTtcbiAgICB9XG4gICAgdGhpcy5lbGVtZW50ID0gdGhpcy5lbGVtZW50cy5jcmVhdGUoJ3BheW1lbnRSZXF1ZXN0QnV0dG9uJywge1xuICAgICAgcGF5bWVudFJlcXVlc3Q6IHRoaXMucGF5bWVudFJlcXVlc3QsXG4gICAgICAuLi5vcHRpb25zXG4gICAgfSk7XG5cbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLnBheW1lbnRSZXF1ZXN0LmNhbk1ha2VQYXltZW50KCk7XG4gICAgaWYgKHJlc3VsdCkge1xuICAgICAgdGhpcy5lbGVtZW50Lm9uKCdjbGljaycsIChldikgPT4gdGhpcy5jaGFuZ2UuZW1pdChldikpO1xuICAgICAgdGhpcy5lbGVtZW50Lm9uKCdibHVyJywgKCkgPT4gdGhpcy5ibHVyLmVtaXQoKSk7XG4gICAgICB0aGlzLmVsZW1lbnQub24oJ2ZvY3VzJywgKCkgPT4gdGhpcy5mb2N1cy5lbWl0KCkpO1xuICAgICAgdGhpcy5lbGVtZW50Lm9uKCdyZWFkeScsICgpID0+IHRoaXMucmVhZHkuZW1pdCgpKTtcblxuICAgICAgdGhpcy5lbGVtZW50Lm1vdW50KHRoaXMuc3RyaXBlRWxlbWVudFJlZi5uYXRpdmVFbGVtZW50KTtcblxuICAgICAgdGhpcy5sb2FkLmVtaXQoe1xuICAgICAgICBwYXltZW50UmVxdWVzdEJ1dHRvbjogdGhpcy5lbGVtZW50LFxuICAgICAgICBwYXltZW50UmVxdWVzdDogdGhpcy5wYXltZW50UmVxdWVzdFxuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMubm90YXZhaWxhYmxlLmVtaXQoKTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==